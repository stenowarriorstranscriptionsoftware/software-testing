<!DOCTYPE html>
<html>
<head>
  <title>EduAccess</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 500px; margin: auto; }
    body.dark { background: #111; color: #eee; }
    #dashboard { display: none; }
    img { max-width: 100%; margin-top: 10px; }
    button { padding: 10px; margin: 5px 0; }
  </style>
</head>
<body>
  <h2>EduAccess Portal</h2>

  <div id="auth">
    <input id="email" placeholder="Email" /><br><br>
    <input id="password" placeholder="Password" type="password" /><br><br>
    <button onclick="signUp()">Sign Up</button>
    <button onclick="login()">Log In</button>
  </div>

  <div id="dashboard">
    <p id="statusMsg"></p>

    <div id="uploadSection">
      <h3>Step 1: Pay via QR</h3>
      <img src="your-qr-code.png" alt="QR Code"><br><br>

      <h3>Step 2: Upload Payment Screenshot</h3>
      <input type="file" id="screenshot" /><br><br>
      <button onclick="uploadScreenshot()">Upload</button>
    </div>

    <div id="content" style="display:none;">
      <h3>âœ… Welcome to the learning area!</h3>
      <p>Protected content goes here.</p>
    </div>

    <button onclick="logout()">Log Out</button>
    <button onclick="toggleDark()">ðŸŒ™ Toggle Dark Mode</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB9vruL_f9KZPC-Ihdj3UuqcXSgy1Lzqm0",
      authDomain: "score-collection.firebaseapp.com",
      databaseURL: "https://score-collection-default-rtdb.firebaseio.com",
      projectId: "score-collection",
      storageBucket: "score-collection.appspot.com",
      messagingSenderId: "720795371551",
      appId: "1:720795371551:web:78ff7863cbeaca0161ed2a",
      measurementId: "G-L6MHY1KCZ0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Auth
    async function signUp() {
      const email = emailEl.value;
      const password = passwordEl.value;
      await auth.createUserWithEmailAndPassword(email, password);
    }

    async function login() {
      const email = emailEl.value;
      const password = passwordEl.value;
      await auth.signInWithEmailAndPassword(email, password);
    }

    async function logout() {
      await auth.signOut();
      location.reload();
    }

    auth.onAuthStateChanged(async user => {
      if (user) {
        document.getElementById('auth').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';

        const docRef = db.collection("users").doc(user.uid);
        const doc = await docRef.get();

        const now = new Date();

        if (doc.exists && doc.data().paidUntil?.toDate() > now) {
          document.getElementById("statusMsg").textContent = "âœ… Subscription active until: " + doc.data().paidUntil.toDate().toDateString();
          document.getElementById("content").style.display = 'block';
          document.getElementById("uploadSection").style.display = 'none';
        } else {
          document.getElementById("statusMsg").textContent = "ðŸ”’ Access locked. Please upload payment screenshot.";
        }
      }
    });

    async function uploadScreenshot() {
      const file = document.getElementById('screenshot').files[0];
      if (!file) return alert('Please select a screenshot.');

      const user = auth.currentUser;
      const ref = storage.ref(`payments/${user.uid}/${file.name}`);
      await ref.put(file);

      await db.collection("users").doc(user.uid).set({
        screenshotUploaded: true,
        approved: false
      }, { merge: true });

      alert("Screenshot uploaded! Admin will review and activate your access.");
    }

    // Dark Mode
    function toggleDark() {
      document.body.classList.toggle("dark");
    }

    // Shortcut references
    const emailEl = document.getElementById("email");
    const passwordEl = document.getElementById("password");
  </script>
</body>
</html>
